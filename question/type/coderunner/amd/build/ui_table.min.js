define(["jquery"],function(a){function b(b,c,d,e){return this.textArea=a(document.getElementById(b)),this.readOnly=this.textArea.prop("readonly"),this.tableDiv=null,this.templateParams=e,e.table_num_columns&&e.table_num_rows?(this.fail=!1,this.lockedCells=e.table_locked_cells||[],this.hasHeader=e.hasOwnProperty("table_column_headers"),this.hasRowLabels=e.hasOwnProperty("table_row_labels"),this.numDataColumns=e.table_num_columns,this.totNumColumns=this.numDataColumns+(this.hasRowLabels?1:0),this.columnWidths=this.computeColumnWidths(),void this.reload()):(this.fail=!0,void(this.failString="table_ui_missingparams"))}return b.prototype.computeColumnWidths=function(){var a=Math.trunc(100/this.totNumColumns),b=[];if(this.templateParams.table_column_width_percents)return this.templateParams.table_column_width_percents;if(Array.prototype.fill)return new Array(this.totNumColumns).fill(a);for(var c=0;c<this.totNumColumns;c++)b.push(a);return b},b.prototype.isLockedCell=function(a,b){for(var c=0;c<this.lockedCells.length;c++)if(this.lockedCells[c][0]==a&&this.lockedCells[c][1]==b)return!0;return!1},b.prototype.getElement=function(){return this.tableDiv},b.prototype.failed=function(){return this.fail},b.prototype.failMessage=function(){return this.failString},b.prototype.sync=function(){var b=[],c=!0,d=a(this.tableDiv).find("table tbody tr");d.each(function(){var d=[];a(this).find("textarea").each(function(){var b=a(this).val();d.push(b),b&&(c=!1)}),b.push(d)}),c?this.textArea.val(""):this.textArea.val(JSON.stringify(b))},b.prototype.tableRow=function(a,b){var c,d="<tr>",e=0;this.hasRowLabels&&(c=this.columnWidths[0],e=1,d+="<th style='padding-top:8px;text-align:center;width:"+c+"%' scope='row'>",a<this.templateParams.table_row_labels.length&&(d+=this.templateParams.table_row_labels[a]),d+="</th>");for(var f=0;f<this.numDataColumns;f++)c=this.columnWidths[e++],d+="<td style='padding:2px;margin:0,width:"+c+"'%>",d+='<textarea rows="2" style="width:100%;padding:0;resize:vertical;font-family: monospace"',d+=this.isLockedCell(a,f)?" disabled>":">",a<b.length&&(d+=b[a][f]),d+="</textarea>",d+="</td>";return d+="</tr>"},b.prototype.tableHeadSection=function(){var a="<thead>\n",b=0;if(this.hasHeader){a+="<tr>",this.hasRowLabels&&(a+="<th style='width:"+this.columnWidths[0]+"%'></th>",b+=1);for(var c=0;c<this.numDataColumns;c++)a+="<th style='width:"+this.columnWidths[b]+"%'>",c<this.templateParams.table_column_headers.length&&(a+=this.templateParams.table_column_headers[c]),b++,a+="</th>";a+="</tr>\n"}return a+="</thead>\n"},b.prototype.reload=function(){var b=a(this.textArea).val(),c=[],d="<div style='height:fit-content' class='qtype-coderunner-table-outer-div'>\n<table class='table table-bordered qtype-coderunner_table'>\n";if(b)try{c=JSON.parse(b)}catch(e){return this.fail=!0,void(this.failString="table_ui_invalidjson")}try{d+=this.tableHeadSection(),d+="<tbody>\n";for(var f=Math.max(this.templateParams.table_num_rows,c.length),g=0;g<f;g++)d+=this.tableRow(g,c);d+="</tbody>\n</table>\n</div>",this.tableDiv=a(d),this.templateParams.table_dynamic_rows&&this.addButtons()}catch(e){this.fail=!0,this.failString="table_ui_invalidserialisation"}},b.prototype.addButtons=function(){var b='<button type="button"style="float:right;margin-right:6px" disabled>Delete row</button>',c=a(b),d=this;this.tableDiv.append(c),c.click(function(){var b=d.tableDiv.find("table tbody tr").length,c=d.tableDiv.find("tr:last");b>d.templateParams.table_num_rows&&c.remove(),c=d.tableDiv.find("tr:last"),b==d.templateParams.table_num_rows+1&&a(this).prop("disabled",!0)});var e='<button type="button"style="float:right;margin-right:6px">Add row</button>',f=a(e);d.tableDiv.append(f),f.click(function(){var b,c;b=d.tableDiv.find("table tbody tr:last"),c=b.clone(),c.find("textarea").each(function(){a(this).val("")}),b.after(c),a(this).prev().prop("disabled",!1)})},b.prototype.resize=function(){},b.prototype.hasFocus=function(){var b=!1;return a(this.tableDiv).find("textarea").each(function(){this===document.activeElement&&(b=!0)}),b},b.prototype.destroy=function(){this.sync(),a(this.tableDiv).remove(),this.tableDiv=null},{Constructor:b}});